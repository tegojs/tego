# TachyBase Core 2.0 重构路线：面向 DI 容器的核心框架

> 本文档总结向 TachyBase 2.0 迈进的核心重构方向：将绝大多数服务解耦为插件或容器注册项，核心仅保留最基础的运行时能力。本次变更为 **不兼容升级**，允许对既有结构进行大幅调整，但需要明确收益与迁移指引，并兼顾单机与 cluster 部署模式。

## 目标与边界

- **核心职责** 仅保留：
  - 插件加载与生命周期编排
  - 事件系统（同步 / 异步）
  - 依赖注入容器（注册、解析、作用域管理）
  - 配置解析与合并
  - 应用生命周期（load/start/stop/restart/destroy）
  - CLI 命令框架
  - 环境管理（环境变量、运行模式、实例身份）
- **服务职责** 均迁移至容器或插件：
  - 数据源、ORM、迁移工具
  - 访问控制、认证、缓存、国际化
  - 网关 (HTTP/WS)、通知中心、定时任务
  - 日志、事件跟踪、监控、Pub/Sub
  - 插件状态存储、消息同步、版本管理

## 核心模块重构要点

### 1. 依赖注入容器
- 引入统一的 `Container` 接口，支持 token 注册、作用域、延迟解析。
- 核心仅注册基础服务（配置、事件总线、生命周期协调器、默认日志实现等）。
- 提供容器扩展点给插件在 `beforeLoad`/`load` 阶段注册自己的服务。
- 支持容器快照 / 回滚，方便插件卸载与热重载。

### 2. 插件系统
- 插件描述文件新增容器声明，支持“最早注册”插件注入关键服务。
- 插件生命周期与容器结合：`beforeLoad` 注册服务 → `load` 使用服务 → `beforeDisable`/`afterDisable` 清理。
- 插件管理状态统一通过 `PluginRegistry` 抽象（可选持久化或内存）。

### 3. 事件与生命周期
- 核心保留 `emit` / `emitAsync` 能力，事件名标准化，便于插件订阅。
- 生命周期钩子重新梳理（见 `plugin-lifecycle.*.md`），核心新增容器可感知的钩子（如 `beforeContainerInit`）。
- 在 cluster 环境中，通过容器注册的 Pub/Sub 或 IPC 适配器分发事件。

### 4. CLI 与配置
- CLI 命令通过容器解析依赖，默认注入 Logger、Registry、LifecycleManager。
- 配置源抽象为 `ConfigurationProvider`，支持文件、环境变量、远程配置等。
- 核心读取配置后写入容器，由插件按需扩展（如数据库连接、缓存策略）。

### 5. 环境与实例管理
- 环境信息（运行模式、集群角色、实例 ID）通过容器暴露。
- `AppSupervisor` 保留为容器注册的单例服务，用于管理多实例状态。
- Cluster 模式新增集群协调服务（锁、主从选举、广播）由容器提供实现。

## 迁移步骤建议

1. **抽象接口**：为现有核心服务定义 DI 接口（如 `Logger`, `CacheProvider`, `Scheduler`）。
2. **插件化实现**：将数据库、网关、ACL 等实现拆分为插件，内部通过容器注册接口实现。
3. **引导流程重写**：
   - Application 初始化 → 创建容器 → 注册核心服务 → 执行插件注册与加载 → 绑定 CLI / 事件。
   - 拆分 `Application.init()` 中直接 new 的逻辑。
4. **状态管理**：结合 `refactor-shared-state.*.md`，明确单写多读或 Redis 等策略，容器提供相应适配器。
5. **兼容性标记**：对外 API、配置格式、插件接口梳理破坏性调整，提供迁移提示文档。
6. **测试与回归**：建立最小核心 + 插件组合的单元测试、cluster 集成测试。

## Cluster 模式适配

- 容器内注册的服务可声明运行模式（单例 / 每进程 / 分布式），容器负责根据部署选择实现。
- 插件可从容器解析到共享状态（Redis、文件、消息总线）或本地状态，按照策略选择。
- CLI 在主进程执行写操作，变更通过事件广播到其他进程刷新容器实例。
- 定时任务、插件状态等建议默认采取“单写多读”策略，可按需切换到共享存储。

## 命名与模块拆分计划

- **核心类重命名**：
  - 将 `Application` 及其文件（如 `application.ts`）重命名为 `Tego`，同时更新所有引用、事件名称、日志前缀、上下文字段、配置项。
  - CLI 输出与错误提示同步使用 `Tego` 命名，避免旧名称残留。
- **精简核心实现**：
  - 在重命名前梳理 `Application` 中的辅助逻辑，移除或迁移到容器/插件。
  - 删除废弃的 CLI 方法与 Legacy API，确保 `Tego` 仅承担最小职责集。
- **标准核心插件化**：
  - 新增 `module-standard-core` 插件，封装数据库、ACL、缓存、网关、Cron、国际化、Pub/Sub 等“原核心”功能。
  - 插件在 `beforeLoad` 阶段向容器注册服务，并提供默认配置；核心只需加载该插件即可恢复旧版能力。
  - 允许业务根据需要替换或移除插件内部子模块，核心保持无侵入。

## 潜在收益

- 核心更轻量，插件化扩展更易管理；不同产品线可以基于同一核心快速组合能力。
- 更好支持云原生和多租户部署：容器可注入云服务适配器，核心无需感知底层实现。
- Cluster 运行更具弹性：通过容器切换到分布式实现即可支持横向扩展。
- 提升测试与演进效率：核心模块具备明确接口，插件单独测试即可验证业务逻辑。

## 不兼容变更提醒

- 旧有直接访问 `app.db`, `app.logger`, `app.cache` 等属性的代码需要改为通过容器解析。
- 插件清单和配置格式可能发生变化，需要编写迁移脚本。
- CLI 参数、命令行为进行适配后需更新文档和自动化脚本。
- 对第三方插件需发布新版本或提供适配层。

> **后续行动**：在 `docs/` 中维护迁移清单、示例插件、容器注册样板；发布 2.x Beta 时同步上线开发者指南与测试矩阵。

